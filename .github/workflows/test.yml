# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# GitHub recommends pinning actions to a commit SHA.
# To get a newer version, you will need to update the SHA.
# You can also reference a tag or branch, but the action may change without warning.

name: Publish Docker image

on: push

jobs:
  deploy:
    name: deploy fly
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: checkout repo
        uses: actions/checkout@v3
        with:
            fetch-depth: 10
      - name: Config file access    
        env:
          APP_HOST: ${{ vars.APP_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_SCHEMA: ${{ secrets.DB_SCHEMA }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_TABLE: ${{ secrets.DB_TABLE }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          AUTO_STOP_MACHINES: ${{ secrets.AUTO_STOP_MACHINES }}
          PORT: ${{ secrets.PORT }}
        run: |
          sed -e "s|replace_APP_HOST|$APP_HOST|g" -e "s|replace_DB_PORT|$DB_PORT|g" -e "s|replace_DB_USER|$DB_USER|g" -e "s|replace_DB_PASSWORD|$DB_PASSWORD|g" -e "s|replace_DB_HOST|$DB_HOST|g" -e "s|replace_DB_SCHEMA|$DB_SCHEMA|g" -e "s|replace_DB_TABLE|$DB_TABLE|g" -e "s|replace_LINE_CHANNEL_ACCESS_TOKEN|$LINE_CHANNEL_ACCESS_TOKEN|g" -e "s|replace_LINE_CHANNEL_SECRET|LINE_CHANNEL_SECRET|g" -e "s|replace_PORT|$PORT|g" -e "s|replace_AUTO_STOP_MACHINES|$AUTO_STOP_MACHINES|g" fly.toml
          cat fly.toml
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
